---
description: Consolidated Supabase and SQL guidelines. Use when writing SQL queries, migrations, functions, or working with Supabase-specific features like Realtime and Edge Functions.
alwaysApply: false
---

# Supabase & SQL Guidelines

## SQL Style

- Use lowercase for SQL reserved words
- Use snake_case for tables/columns, plural table names, singular column names
- Store dates in ISO 8601 format
- Always add `id bigint generated always as identity primary key` unless specified
- Create tables in `public` schema, always qualify with schema name
- Add table comments describing purpose
- Use `as` keyword for aliases
- Prefer CTEs for complex queries
- Use double apostrophes in SQL strings: `'Night''s watch'`

## Migrations

- File naming: `YYYYMMDDHHmmss_short_description.sql` (UTC)
- Location: `supabase/migrations/`
- Include header comments with purpose and affected tables
- Write all SQL in lowercase
- Add comments for destructive operations
- Always enable RLS on new tables, even for public access
- Create granular RLS policies: one per operation (select/insert/update/delete) and per role (anon/authenticated)

## Database Functions

- Default to `SECURITY INVOKER` (use `SECURITY DEFINER` only when required)
- Always set `set search_path = ''`
- Use fully qualified names (e.g., `public.table_name`)
- Prefer `IMMUTABLE` or `STABLE` over `VOLATILE` when possible
- Specify explicit input/output types

```sql
create or replace function public.calculate_total(order_id bigint)
returns numeric
language plpgsql
security invoker
set search_path = ''
as $$
declare
  total numeric;
begin
  select sum(price * quantity) into total
  from public.order_items
  where order_id = calculate_total.order_id;
  return total;
end;
$$;
```

## RLS Policies

- Use `auth.uid()` instead of `current_user`
- SELECT: use `USING`, not `WITH CHECK`
- INSERT: use `WITH CHECK`, not `USING`
- UPDATE: use both `USING` and `WITH CHECK`
- DELETE: use `USING`, not `WITH CHECK`
- Don't use `FOR ALL`; create separate policies per operation
- Use `TO authenticated` or `TO anon` to specify roles
- Wrap functions with `select`: `(select auth.uid()) = user_id`
- Prefer `PERMISSIVE` over `RESTRICTIVE`
- Add indexes on columns used in policies

```sql
create policy "Users can view own records" on profiles
for select
to authenticated
using ((select auth.uid()) = user_id);
```

## Realtime

- Use `broadcast` for all realtime events (avoid `postgres_changes`)
- Use `presence` sparingly for user state tracking
- Topic naming: `scope:entity:id` (e.g., `room:123:messages`)
- Event naming: `entity_action` (snake_case, e.g., `message_created`)
- Always set `private: true` for channels using database triggers
- Include unsubscribe/cleanup logic
- Use dedicated topics per logical scope for better performance
- Set auth before subscribing: `await supabase.realtime.setAuth()`

### Database Triggers

```sql
create or replace function notify_table_changes()
returns trigger
security definer
language plpgsql
as $$
begin
  perform realtime.broadcast_changes(
    tg_table_name || ':' || coalesce(new.id, old.id)::text,
    tg_op,
    tg_op,
    tg_table_name,
    tg_table_schema,
    new,
    old
  );
  return coalesce(new, old);
end;
$$;
```

### RLS for Private Channels

```sql
create policy "room_members_can_read" on realtime.messages
for select to authenticated
using (
  topic like 'room:%' and
  exists (
    select 1 from room_members
    where user_id = auth.uid()
    and room_id = split_part(topic, ':', 2)::uuid
  )
);
```

## Edge Functions

- Use Web APIs and Deno core APIs (fetch, WebSockets) instead of external deps
- Shared utilities: `supabase/functions/_shared` (no cross-dependencies)
- External imports: use `npm:` or `jsr:` with versions (e.g., `npm:@supabase/supabase-js@2.39.0`)
- Node APIs: import with `node:` specifier (e.g., `import process from "node:process"`)
- Use `Deno.serve` (not `serve` from deno.land/std)
- Pre-populated env vars: `SUPABASE_URL`, `SUPABASE_PUBLISHABLE_OR_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_DB_URL`
- File writes: only in `/tmp` directory
- Long-running tasks: use `EdgeRuntime.waitUntil(promise)`
- Route prefix: `/function-name` for multi-route functions

```typescript
Deno.serve(async (req: Request) => {
  const { name } = await req.json()
  return new Response(JSON.stringify({ message: `Hello ${name}` }), {
    headers: { 'Content-Type': 'application/json', Connection: 'keep-alive' },
  })
})
```
